const Database = require('better-sqlite3');
const path = require('path');
require('dotenv').config({ path: path.join(__dirname, '../.env.local') });

const PROJECT_ROOT = path.join(__dirname, '..');
const DB_PATH = path.resolve(PROJECT_ROOT, process.env.DB_PATH || 'imessage-agent.db');
const db = new Database(DB_PATH);

db.exec(`
  -- Settings table
  CREATE TABLE IF NOT EXISTS settings (
    key TEXT PRIMARY KEY,
    value TEXT NOT NULL
  );

  -- Contacts allowlist
  -- auto_reply: 0 = off, 1 = on
  -- mode: 'always' | 'when_busy' | 'manual_trigger'
  CREATE TABLE IF NOT EXISTS contacts (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    phone_or_handle TEXT UNIQUE NOT NULL,
    display_name TEXT,
    auto_reply INTEGER DEFAULT 0,
    mode TEXT DEFAULT 'always',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
  );

  -- Voice persona â€” the "warmup" data
  CREATE TABLE IF NOT EXISTS persona (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    category TEXT NOT NULL,
    example TEXT NOT NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
  );

  -- Processed persona summary (generated by Claude from examples)
  CREATE TABLE IF NOT EXISTS persona_summary (
    id INTEGER PRIMARY KEY DEFAULT 1,
    summary TEXT,
    tone TEXT,
    quirks TEXT,
    sample_phrases TEXT,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
  );

  -- Message log
  CREATE TABLE IF NOT EXISTS message_log (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    phone_or_handle TEXT NOT NULL,
    direction TEXT NOT NULL,
    body TEXT NOT NULL,
    auto_generated INTEGER DEFAULT 0,
    sent_at DATETIME DEFAULT CURRENT_TIMESTAMP
  );

  -- Seen messages (to avoid double-processing)
  CREATE TABLE IF NOT EXISTS seen_messages (
    message_id TEXT PRIMARY KEY,
    processed_at DATETIME DEFAULT CURRENT_TIMESTAMP
  );

  -- Insert defaults
  INSERT OR IGNORE INTO settings (key, value) VALUES ('agent_enabled', '0');
  INSERT OR IGNORE INTO settings (key, value) VALUES ('warmup_complete', '0');
  INSERT OR IGNORE INTO settings (key, value) VALUES ('reply_delay_min_ms', '2000');
  INSERT OR IGNORE INTO settings (key, value) VALUES ('reply_delay_max_ms', '8000');
`);

module.exports = db;
